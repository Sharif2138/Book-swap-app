import 'package:flutter/foundation.dart';
import 'package:bookswap_app/models/user_model.dart';
import 'package:bookswap_app/services/cloud_firestore_service.dart';

class UserProvider extends ChangeNotifier {
  // ü§ù Dependency: Uses the service to talk to Firestore
  final CloudFirestoreService _userService = CloudFirestoreService();

  // üîí Private Cache: Stores user profiles that have already been fetched
  // Key: userId, Value: UserModel
  final Map<String, UserModel> _userCache = {};
  
  // üéØ Public Getters
  // We expose the cache for quick lookups in widgets, but prefer using fetchUser().
  Map<String, UserModel> get userCache => _userCache;

  // --- Profile Retrieval with Caching ---
  
  /// Fetches a UserModel by ID, checking the cache first to minimize Firestore reads.
  Future<UserModel?> fetchUser(String userId) async {
    // 1. Check cache
    if (_userCache.containsKey(userId)) {
      return _userCache[userId];
    }

    // 2. Fetch from Firestore if not in cache
    final user = await _userService.getUser(userId: userId);

    // 3. Cache and notify if successful
    if (user != null) {
      _userCache[userId] = user;
      // Notify listeners that a new user has been loaded into the cache.
      notifyListeners(); 
    }
    
    return user;
  }
}